file:
  /usr/local/bin/scp:
    exists: true
    mode: '0755'
    owner: 'root'
    group: 'root'

command:
  scp-log:
    exec: 'scp log "Hello, the %s is %d" "answer" 42'
    exit-status: 0
    stderr:
      - '/\bHello, the answer is 42$/'

  scp-exec/default:
    exec: |
      set -euo pipefail
      [ "$(id -u):$(id -g)" != "0:0" ] && echo "__SKIP__" && exit 0
      scp exec id
    exit-status: 0
    stdout:
      - '/__SKIP__|uid=0\(root\) gid=0\(root\)/'

  scp-exec/user:
    exec: |
      set -euo pipefail
      [ "$(id -u):$(id -g)" != "0:0" ] && echo "__SKIP__" && exit 0
      scp exec -p nobody id
    exit-status: 0
    stdout:
      - '/__SKIP__|uid=65534\(nobody\) gid=65534\(nobody\)/'

  scp-exec/user-and-group:
    exec: |
      set -euo pipefail
      [ "$(id -u):$(id -g)" != "0:0" ] && echo "__SKIP__" && exit 0
      scp exec -p nobody:nogroup id
    exit-status: 0
    stdout:
      - '/__SKIP__|uid=65534\(nobody\) gid=65533\(nogroup\)/'

  scp-exec/uid:
    exec: |
      set -euo pipefail
      [ "$(id -u):$(id -g)" != "0:0" ] && echo "__SKIP__" && exit 0
      scp exec -p 4201 id
    exit-status: 0
    stdout:
      - '/__SKIP__|uid=4201 gid=0(root)/'

  scp-exec/gid:
    exec: |
      set -euo pipefail
      [ "$(id -u):$(id -g)" != "0:0" ] && echo "__SKIP__" && exit 0
      scp exec -p :4202 id
    exit-status: 0
    stdout:
      - '/__SKIP__|uid=0\(root\) gid=4202/'

  scp-exec/uid-and-gid:
    exec: |
      set -euo pipefail
      [ "$(id -u):$(id -g)" != "0:0" ] && echo "__SKIP__" && exit 0
      scp exec -p 4201:4202 id
    exit-status: 0
    stdout:
      - '/__SKIP__|uid=4201 gid=4202/'

  scp-directory/default:
    exec: |
      set -euo pipefail
      [ "$(id -u):$(id -g)" != "0:0" ] && echo "__SKIP__" && exit 0
      rm -rf /tmp/scp-dir-1
      scp directory /tmp/scp-dir-1
      stat -c '%U:%G:%a' /tmp/scp-dir-1
    exit-status: 0
    stdout:
      - '/^(__SKIP__|root:root:755)$/'

  scp-directory/custom:
    exec: |
      set -euo pipefail
      [ "$(id -u):$(id -g)" != "0:0" ] && echo "__SKIP__" && exit 0
      rm -rf /tmp/scp-dir-2
      scp directory -u nobody -g nogroup -m 1750 /tmp/scp-dir-2
      stat -c '%U:%G:%a' /tmp/scp-dir-2
    exit-status: 0
    stdout:
      - '/^(__SKIP__|nobody:nogroup:1750)$/'

  scp-secret/direct:
    exec: |
      set -euo pipefail
      export SCP_SECRET="Top Secret"
      scp secret "SCP_SECRET"
    exit-status: 0
    stdout:
      - '/^Top Secret$/'

  scp-secret/file:
    exec: |
      set -euo pipefail
      echo -n "Top Secret File" > /tmp/scp-secret
      export SCP_SECRET_FILE="/tmp/scp-secret"
      scp secret "SCP_SECRET"
      rm /tmp/scp-secret
    exit-status: 0
    stdout:
      - '/^Top Secret File$/'
