file:
  /usr/local/bin/scp:
    exists: true
    mode: '0755'
    owner: 'root'
    group: 'root'

  /usr/local/lib/scp:
    exists: true
    mode: '0644'
    owner: 'root'
    group: 'root'

command:
  scp-log/debug:
    exec: 'scp debug "Hello %s" "World"'
    exit-status: 0
    stdout:
      - '/\bDEBUG\s*: Hello World$/'

  scp-log/info:
    exec: 'scp info "Hello %s" "World"'
    exit-status: 0
    stdout:
      - '/\bINFO\s*: Hello World$/'

  scp-log/warn:
    exec: 'scp warn "Hello %s" "World"'
    exit-status: 0
    stdout:
      - '/\bWARN\s*: Hello World$/'

  scp-log/error:
    exec: 'scp error "Hello %s" "World"'
    exit-status: 0
    stdout:
      - '/\bERROR\s*: Hello World$/'

  scp-log/fatal:
    exec: 'scp fatal "Hello %s" "World"'
    exit-status: 1
    stdout:
      - '/\bFATAL\s*: Hello World$/'

  scp-runas/root:
    exec: 'scp runas root whoami'
    exit-status: 0
    stdout:
      - '/^root$/'

  scp-runas/nobody:
    exec: 'scp runas nobody whoami'
    exit-status: 0
    stdout:
      - '/^nobody$/'

  scp-prepare-dir:
    exec: |
      set -euo pipefail
      scp prepare-dir /tmp/testdir nobody:root 1775
      stat -c '%U:%G:%a' /tmp/testdir
    exit-status: 0
    stdout:
      - '/^nobody:root:1775$/'

  scp-template/defaults:
    exec: |
      set -euo pipefail
      export TEST="Hello World"
      echo '{{"{{"}} .Env.TEST {{"}}"}}' | scp template - /tmp/tpl-defaults
      cat /tmp/tpl-defaults
      stat -c '%U:%G:%a' /tmp/tpl-defaults
    exit-status: 0
    stdout:
      - '/^Hello World$/'
      - '/^root:root:640$/'

  scp-template/subdir:
    exec: |
      set -euo pipefail
      export TEST="Hello World"
      echo '{{"{{"}} .Env.TEST {{"}}"}}' | scp template - /tmp/subdir/tpl
      cat /tmp/subdir/tpl
      stat -c '%U:%G:%a' /tmp/subdir/tpl
    exit-status: 0
    stdout:
      - '/^Hello World$/'
      - '/^root:root:640$/'

  scp-template/custom:
    exec: |
      set -euo pipefail
      export TEST="Goodbye World"
      echo '{{"{{"}} .Env.TEST {{"}}"}}' | scp template -o nobody:root -m 0600 - /tmp/tpl-custom
      cat /tmp/tpl-custom
      stat -c '%U:%G:%a' /tmp/tpl-custom
    exit-status: 0
    stdout:
      - '/^Goodbye World$/'
      - '/^nobody:root:600$/'

  scp-template/multiple:
    exec: |
      set -euo pipefail
      export TEST="Goodbye World"
      echo '{{"{{"}} .Env.TEST {{"}}"}}' > /tmp/tpl-multi-in
      scp template -o nobody:root -m 0600 /tmp/tpl-multi-in /tmp/tpl-multi-1 /tmp/tpl-multi-in /tmp/tpl-multi-2
      grep -H . /tmp/tpl-multi-1
      grep -H . /tmp/tpl-multi-2
      stat -c '%n:%U:%G:%a' /tmp/tpl-multi-1
      stat -c '%n:%U:%G:%a' /tmp/tpl-multi-2
    exit-status: 0
    stdout:
      - '/^\/tmp\/tpl-multi-1:Goodbye World$/'
      - '/^\/tmp\/tpl-multi-2:Goodbye World$/'
      - '/^\/tmp\/tpl-multi-1:nobody:root:600$/'
      - '/^\/tmp\/tpl-multi-2:nobody:root:600$/'

  scp-secret/direct:
    exec: |
      set -euo pipefail
      export MY_SECRET="Top Secret"
      scp secret "MY_SECRET"
    exit-status: 0
    stdout:
      - '/^Top Secret$/'

  scp-secret/file:
    exec: |
      set -euo pipefail
      echo "Top Secret File" > /tmp/topsecret
      export MY_SECRET_FILE="/tmp/topsecret"
      scp secret "MY_SECRET"
    exit-status: 0
    stdout:
      - '/^Top Secret File$/'
